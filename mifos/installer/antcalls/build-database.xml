<project name="db_installer" default="echo" basedir=".">
        <target name="del">
                <delete dir="build"/>
                <delete dir="lib"/>
                <delete dir="sql"/>
                <delete dir="resources"/>
        </target>

	<target name="build_db" description="Builds the application database without custom config data">
		<sql driver="com.mysql.jdbc.Driver" url="jdbc:mysql://${db.host}:${db.port}/"
			userid="${db.user}" password="${db.password}"
			classpath="./lib/mysql-connector-java-5.1.5-bin.jar">
			<transaction>
				Drop database if exists ${db.schema};
				create database ${db.schema};
				use ${db.schema};
			</transaction>
			<transaction src="./sql/latest-schema.sql" />
			<transaction src="./sql/latest-data.sql" />
			<!-- <transaction src="./sql/Index.sql" /> -->
		</sql>
                <antcall target="update_mifos_password">
                         <param name="db.host" value="${db.host}"/>
                         <param name="db.port" value="${db.port}"/>
                         <param name="db.user" value="${db.user}"/>
                         <param name="db.password" value="${db.password}"/>
                         <param name="db.schema" value="${db.schema}"/>
                </antcall>
    </target>

    <target name="update_mifos_password">
        <echo>Updating Mifos user password</echo>
        <java classname="org.mifos.installer.util.PasswordHasher">
            <arg value="${db.host}"/>
            <arg value="${db.port}"/>
            <arg value="${db.user}"/>
            <arg value="${db.password}"/>
            <arg value="${db.schema}"/>
            <classpath>
		<pathelement location="lib/mysql-connector-java-5.1.5-bin.jar"/>
                <pathelement location="lib/mifos_util.jar"/>
            </classpath>
        </java>
    </target>
    
    <target name="update_hibernate_props">
        <echo>Updating Mifos hibernate properties</echo>
        <copy file="resources/hibernate.properties" todir="${catalina.home}/webapps/mifos/WEB-INF/classes/conf"/>
                <replace file="${catalina.home}/webapps/mifos/WEB-INF/classes/org/mifos/conf/hibernate.properties">
                  <replacefilter 
                    token="@hibernate.connection.url@"
                    value="jdbc:mysql://${db.host}:${db.port}/${db.schema}?useUnicode=true&amp;characterEncoding=UTF-8"/>
                  <replacefilter 
                    token="@hibernate.connection.username@" 
                    value="${db.user}"/>
                  <replacefilter 
                    token="@hibernate.connection.password@" 
                    value="${db.password}"/>
                </replace>
        
    </target>

</project>