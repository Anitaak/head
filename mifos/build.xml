<?xml version="1.0" encoding="UTF-8"?>
<project name="mifos" default="dist" basedir=".">

	<property environment="env"/>
	<property name="build.compiler" value="modern"/>
	<property name="java.home" value="${env.JAVA_HOME}"/>
	<property name="conf.dir" value="${basedir}/conf"/>

	<!-- my.build.properties is your way to override
		properties which are not supposed to be
		checked in.  If it doesn't exist, ant
		will just skip it.  Properties defined
		there override those defined in build.properties
		or in this file -->
	<property file="${conf.dir}/my.build.properties"/>

	<property file="${conf.dir}/build.properties"/>
	
	<!-- Which suite to run in the run_test and profile_test
	     targets.  Normally the whole suite, but can be
	     set to a portion of the tests, for example by putting
	     test.suite=FastTests
	     in my.build.properties.  -->
	<property name="test.suite" value="ApplicationTestSuite" />

	<!-- Probably need about 550M for 64-bit systems 
	     (instead of 350M for 32-bit). -->
	<property name="test.memory" value="350M" />
	<!-- 550M wasn't enough for me, needs more experimentation -->
	<property name="profile.memory" value="550M" />

	<property name="lib.dir" value="${basedir}/lib"/>
	<property name="src.dir" value="${basedir}/src"/>
	<property name="test.dir" value="${basedir}/test"/>
	<property name="sql.dir" value="${basedir}/sql"/>
	<property name="build.dir" value="${basedir}/build"/>
	<property name="dist.dir" value="${basedir}/dist"/>
	<!--property name="doc.dir" value="${basedir}/docs"/-->

	<!--Helper path for building, copying resources etc-->
	<property name="build.src.dir" value="${build.dir}/src_pkg"/>
	<property name="build.test.dir" value="${build.dir}/test_pkg"/>
	<property name="build.web-inf" value="${build.src.dir}/WEB-INF"/>
	<property name="build.classes" value="${build.web-inf}/classes"/>
	<property name="build.lib" value="${build.dir}/lib"/>
	<property name="test.classes" value="${build.test.dir}/classes"/>

	<property name="db.driver" value="com.mysql.jdbc.Driver"/>
	<property name="database.driver.jar" 
		value="./lib/mysql-connector-java-3.1.13-bin.jar"/>
	<path id="class.path">
		<fileset dir="${lib.dir}">
			<include name="**/*.jar"/>
		</fileset>
		<pathelement location="${build.classes}"/>
	</path>

	<!--<echo level="debug">CLASSPATH - ${java.class.path}</echo>-->
  
	<target name="init">
		<tstamp>
			<format property="BUILD_ID" pattern="MMM-dd-yyyy hh:mm aa z" locale="en"/>
		</tstamp>
	</target>

	<target name="check_config">
		<fail message="JAVA_HOME not set. Please set JAVA_HOME" unless="env.JAVA_HOME"/>
		<!--check the jre version-->
	</target>

	<target name="make_dir">
		<mkdir dir="${dist.dir}"/>
		<mkdir dir="${build.classes}"/>
		<mkdir dir="${build.web-inf}"/>
		<mkdir dir="${build.web-inf}/services/MifosService/META-INF"/>
		<mkdir dir="${build.web-inf}/services/MifosService/modules"/>
		<mkdir dir="${test.classes}"/>
		<mkdir dir="${build.classes}/conf"/>
		<mkdir dir="${test.classes}/conf"/>
	</target>

	<target name="clean_src_classes" description="Cleans the source classes">
		<delete>
			<fileset dir="${build.classes}" includes="**/*.class"/>
		</delete>
	</target>

	<target name="clean_test_classes" description="Cleans the test classes">
		<delete>
			<fileset dir="${test.classes}" includes="**/*.class"/>
		</delete>
	</target>

	<target name="clean" description="Cleans the temp build directory">
		<delete dir="${build.dir}"/>
	</target>

	<target name="clean_all" depends="clean">
		<delete dir="${dist.dir}"/>
		<!-- <delete dir="${doc.dir}/api"/> -->
		<!--<delete dir="${src.dir}"/>
		<delete dir="${test.dir}"/>
		<delete dir="${sql.dir}"/>-->
	</target>

	<target name="compile" depends="init,make_dir" description="Compiles the source files">
		<javac srcdir="${src.dir}" 
		       destdir="${build.classes}" 
		       debug="${debug.flag}"
		       deprecation="on"
		       includes="**/*.java"
			
		       excludes="${global.exclude}">
			<classpath refid="class.path"/>
		</javac>
	</target>

	<target name="compile_test" depends="compile" description="Compiles the test files">
		<javac srcdir="${test.dir}" 
		       destdir="${test.classes}" 
		       debug="${debug.flag}"
		       deprecation="on"
		       includes="**/*.java"
		       excludes="${global.exclude}">
			<classpath>
				<path refid="class.path"/>
				<pathelement location="${build.classes}"/>
			</classpath>

		</javac>
	</target>

	<!--
	Note that my.hibernate.properties and my.HibernateTest.properties,
	unlike my.build.properties, entirely override the corresponding
	file if they are present.
	-->
	<target name="copy_files">
        <available file="${conf.dir}/my.hibernate.properties"
                property="my.hibernate.properties.present" value="true" />
		<copy todir="${build.web-inf}/lib">
			<fileset dir="lib" 
				excludes="javax.servlet.jar, jsp-api.jar, strutstest-2.1.3.jar, junit.jar, cobertura.jar, jetty-6.0.0.jar, jetty-util-6.0.0.jar, servlet-api-2.5-6.0.0.jar">
				<exclude name="*.tld"/>
			</fileset>
		</copy>
		<copy todir="${build.web-inf}">
			<fileset dir="${src.dir}/org/mifos/META-INF">
				<exclude name="web.xml"/>
			</fileset>
		</copy>
		<copy todir="${build.classes}/org/mifos/framework/persistence">
			<fileset dir="${sql.dir}">
				<include name="upgrade_to_*.sql" />
			</fileset>
		</copy>
		<copy todir="${build.src.dir}/pages">
			<fileset dir="${src.dir}/org/mifos/doc-root"/>
		</copy>
		<copy todir="${build.classes}/org/mifos/application">
			<fileset dir="${src.dir}/org/mifos/application">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
		<copy todir="${build.classes}/org/mifos/framework">
			<fileset dir="${src.dir}/org/mifos/framework">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
        <copy tofile="${build.classes}/conf/hibernate.properties" verbose="true">
			<fileset dir="${conf.dir}">
                <include name="my.hibernate.properties" 
                	if="my.hibernate.properties.present" />
                <include name="hibernate.properties" 
                	unless="my.hibernate.properties.present" />
			</fileset>
		</copy>
		<copy todir="${build.web-inf}/services/MifosService/META-INF">
		    <fileset dir="${src.dir}/org/mifos/api/resources">
		        <include name="services.xml"/>
		        <include name="*.wsdl"/>
		    </fileset>
		</copy>
		<copy todir="${build.src.dir}/pages/application/reports/uploads">
		    <fileset dir="${src.dir}/org/mifos/application/reports/uploads">
			<include name="*.jrxml"/>
		        <include name="*.jasper"/>
		    </fileset>
		</copy>
	</target>

	<target name="lib" depends="compile" description="Build the mifos library">
            <mkdir dir="${build.lib}"/>
            <copy todir="${build.lib}">
		<fileset dir="${build.classes}">
		    <exclude name="**/struts/**"/>
		</fileset>
            </copy>
            <jar basedir="${build.lib}"
                 destfile="${dist.dir}/mifos-lib.jar"
		 />
	</target>

	<!-- The lib-x target is only for bootstrapping the API. It should go away soon -->
	<target name="lib-x" depends="copy_files">
	  <delete file="${dist.dir}/mifos-x.jar"/>
	  <jar basedir="${build.web-inf}/classes"
	       destfile="${dist.dir}/mifos-x.jar"/>
	</target>

	<target name="api" 
		depends="compile, copy_files, lib, lib-x" 
		description="Build mifos API support"/>

	<target name="copy_test_files">
        <available file="${conf.dir}/my.HibernateTest.properties"
                property="my.HibernateTest.properties.present" value="true"/>
		<copy todir="${test.classes}">
			<fileset dir="${test.dir}">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
		<copy todir="${test.classes}/org/mifos/WEB-INF">
			<fileset dir="${src.dir}/org/mifos/META-INF">
				<exclude name="**/*.java"/>
			</fileset>
		</copy>
        <copy tofile="${test.classes}/conf/HibernateTest.properties" verbose="true">
			<fileset dir="${conf.dir}">
                <include name="HibernateTest.properties" unless="my.HibernateTest.properties.present"/>
                <include name="my.HibernateTest.properties" if="my.HibernateTest.properties.present"/>
			</fileset>
		</copy>

	</target>

	<target name="run_test" 
		depends="compile,copy_files,compile_test,copy_test_files,build_test_db" 
		description="Run tests. Does not initiate clean build">
		<junit printsummary="on" fork="true" maxmemory="${test.memory}" 
			dir="${basedir}"
			failureproperty="tests.failure">
			<classpath>
				<path refid="class.path"/>
				<pathelement location="${build.classes}"/>
				<pathelement location="${test.classes}"/>
			</classpath>

			<formatter type="xml" />
			<batchtest todir="${dist.dir}" >
				<fileset dir="${test.classes}">
					<include name="**/${test.suite}.class" />
				</fileset>
			</batchtest>
		</junit>
		<fail if="tests.failure" 
			message="Unit tests failed - Report is available at ${dist.dir}"/>
	</target>

	<!-- Profile our tests with JIP ( http://jiprof.sourceforge.net/ ).	-->
	<target name="profile_test" 
		depends="compile,copy_files,compile_test,copy_test_files,build_test_db" 
		description="Profile tests">
		<junit printsummary="on" fork="true" maxmemory="${profile.memory}" 
			dir="${basedir}"
			failureproperty="tests.failure">
			<jvmarg value="-javaagent:${lib.dir}/jiprof-1.0.7.jar"/> 
			<jvmarg value="-Dprofile.properties=${conf.dir}/profile.properties"/>
			<classpath>
				<path refid="class.path"/>
				<pathelement location="${build.classes}"/>
				<pathelement location="${test.classes}"/>
			</classpath>

			<formatter type="xml" />
			<batchtest todir="${dist.dir}" >
				<fileset dir="${test.classes}">
					<include name="**/${test.suite}.class" />
				</fileset>
			</batchtest>
		</junit>
		<fail if="tests.failure" 
			message="Unit tests failed - Report is available at ${dist.dir}"/>
	</target>

	<target name="war" depends="compile,copy_files">
		<delete file="${dist.dir}/${webapplication.name}.war"/>
		<war destfile="${dist.dir}/${webapplication.name}.war" 
			webxml="${src.dir}/org/mifos/META-INF/web.xml">
			<fileset dir="${build.src.dir}/"/>
		</war>
	</target>

	<target name="dist" 
		depends="clean,compile,copy_files,compile_test,copy_test_files,run_test,war,deploy" 
		description="Compiles, runs test, builds a distributable war and places in the dist directory. Copies to the web server in use. Does not rebuild the production database"
	/>

	<target name="dist_build_db" 
		depends="clean,compile,copy_files,compile_test,copy_test_files,run_test,war,deploy,build_db" 
		description="Compiles, runs test, builds a distributable war and places in the dist directory. Copies to the web server in use. Rebuilds the production database"
	/>

	<!--<target name="test_dist" depends="compile" description="Compiles, runs test cass and prepares the final war for distribution">
	</target>-->

	<target name="clean_build" depends="check_config,clean_all,dist_build_db" 
		description="Initates a clean build, cleaning all directories and getting a fresh copy from source control"/>

	<target name="build_db" description="Builds the application database">
		<sql driver="${db.driver}" url="jdbc:mysql://${db.ip}:${db.port}/" 
			userid="${db.user}" password="${db.pwd}"
			classpath="${database.driver.jar}">
			<transaction>
				Drop database if exists ${db.name};
				create database ${db.name};			
				use ${db.name};
			</transaction>
			<transaction src="./sql/mifosdroptables.sql" />
            <transaction src="./sql/latest-schema.sql" />
            <transaction src="./sql/latest-data.sql" />
			<!-- <transaction src="./sql/Index.sql" /> -->
		</sql>
	</target>

	<target name="build_test_db">
		<sql driver="${db.driver}" url="jdbc:mysql://${testdb.ip}:${testdb.port}/" 
			userid="${testdb.user}" password="${testdb.pwd}"
			classpath="${database.driver.jar}">
			<!--transaction src="./create.sql"/-->
			<transaction>
				Drop database if exists ${testdb.name};
				create database ${testdb.name};
				use ${testdb.name};
			</transaction>
			<!-- The following list of scripts is supposed to
			     be the same as the one in build_db except
			     for testdbinsertionscript.sql.  I just
			     haven't yet figured out how I can factor
			     out the duplication in ant.
			-->
			<transaction src="./sql/mifosdroptables.sql" />
            <transaction src="./sql/latest-schema.sql" />
            <transaction src="./sql/latest-data.sql" />
			<!-- <transaction src="./sql/Index.sql" /> -->

			<transaction src="./sql/testdbinsertionscript.sql" />
		</sql>
	</target>

	<target name="deploy" depends="war">
		<echo message="Deploying application ${webapplication.name}.war to ${deploy.destination}"/>
		<copy file="${dist.dir}/${webapplication.name}.war" 
			todir="${deploy.destination}"
		/>
	</target>

	<target name="javadoc">
	<!--
		<mkdir dir="${doc.dir}/api"/>
		<javadoc packagenames="org.*"
			 sourcepath="${src.dir}" 
			 destdir="${doc.dir}/api"
			 author="true" version="true" use="true">
			<classpath refid="class.path"/>
		</javadoc>
	-->
	</target>

	<!--<target name="src-zip" depends="compile" description="Creates source distribution">
		<delete>
			<fileset dir="${dist.dir}" includes="mifos-src.zip" />
		</delete>
		<zip basedir="${basedir}" destfile="${dist.dir}/mifos-src.zip" whenempty="fail">
			<fileset dir="${basedir}">
				<include name="**/*.*" />
				<exclude name="${dist.dir}/**/*"/>
				<exclude name="${build.dir}/**/*"/>
				<exclude name="${doc.dir}/**/*"/>
			</fileset>
		</zip>
	</target>-->
	
</project>
