<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">

    <var name="savingsAccountFormBean" class="org.mifos.ui.core.controller.CreateSavingsAccountFormBean" />
    
    <view-state id="customerSearchStep" view="createSavingsAccountCustomerSearch" model="savingsAccountFormBean">
        <transition on="searchTermEntered" to="selectCustomerStep" validate="true">
            <evaluate expression="createSavingsAccountController.searchCustomers(savingsAccountFormBean)" result="flowScope.customerSearchResultsDto" />
        </transition>
    </view-state>

    <view-state id="selectCustomerStep" view="createSavingsAccountSelectCustomer" model="savingsAccountFormBean">
        <transition on="customerSelected" to="selectProductOfferingStep">
            <set name="requestScope.customerId" value="requestParameters.customerId" type="int" />
            <evaluate expression="createSavingsAccountController.customerSelected(customerId, savingsAccountFormBean)" />
            <evaluate expression="createSavingsAccountController.getProductOfferings(savingsAccountFormBean)" />
        </transition>
        <transition on="searchTermEntered" to="selectCustomerStep" validate="true" />
    </view-state>

    <view-state id="selectProductOfferingStep" view="createSavingsAccountSelectProduct" model="savingsAccountFormBean">
        <transition on="productSelected" to="enterAccountDetailsStep">
            <set name="requestScope.productId" value="requestParameters.productId" type="int"/>
            <evaluate expression="createSavingsAccountController.loadProduct(productId, savingsAccountFormBean)" />
        </transition>
    </view-state>

    <view-state id="enterAccountDetailsStep" view="createSavingsAccountEnterDetails" model="savingsAccountFormBean">
        <transition on="newProductSelected" to="enterAccountDetailsStep" validate="false">
            <!-- TODO use on state entry instead of duplicating code from above? -->
            <set name="requestScope.productId" value="requestParameters.productId" type="int"/>
            <evaluate expression="createSavingsAccountController.loadProduct(productId, savingsAccountFormBean)" />
        </transition>
        <transition on="detailsEntered" to="previewStep" />
    </view-state>

    <view-state id="previewStep" view="createSavingsAccountPreview">
        <transition on="edit" to="enterAccountDetailsStep" />
        <transition on="saveForLater" to="complete">
            <evaluate expression="createSavingsAccountController.createAccountInPartialApplicationState(savingsAccountFormBean)" result="flowScope.account" />
        </transition>
        <transition on="saveForApproval" to="complete" >
            <evaluate expression="createSavingsAccountController.createAccountInPendingApprovalState(savingsAccountFormBean)" result="flowScope.account" />
        </transition>
    </view-state>

    <end-state id="complete" view="createSavingsAccountComplete" />
    <end-state id="cancel" view="externalRedirect:contextRelative:/custSearchAction.do?method=loadSearch"/>
    
    <global-transitions>
        <transition on="cancel" to="cancel" />
    </global-transitions>
</flow>
